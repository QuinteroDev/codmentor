{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Generate a Programming Exercise</h2>
    <form method="POST" id="exercise-form">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary mt-3">Generate Exercise</button>
    </form>

    {% if exercise %}
    <h3>Exercise:</h3>
    <pre>{{ exercise }}</pre>

    <!-- Contenedor del editor -->
    <textarea id="code-editor" name="code-editor"></textarea>

    <!-- Descripción del ejercicio (puede estar oculta o visible según necesites) -->
    <textarea id="exercise_description" name="exercise_description" style="display:none;">
        {{ exercise }}
    </textarea>

    <button id="run-code-btn" class="btn btn-success mt-3">Run Code</button>
    <div id="exercise-result" class="mt-4"></div>
    {% endif %}
</div>

<!-- Inicialización de CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>

<!-- Estilos adicionales para mejorar la apariencia -->
<style>
    .CodeMirror {
        border: 1px solid #ddd;
        height: 300px;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar CodeMirror
    var editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
        mode: "python",
        lineNumbers: true,
        theme: "default",
        tabSize: 4,
        indentWithTabs: true,
    });

    document.getElementById('run-code-btn').onclick = function(event) {
        event.preventDefault();
        var code = editor.getValue();
        var exerciseDescription = document.getElementById('exercise_description') ? document.getElementById('exercise_description').value : null;
        var languageElement = document.getElementById('id_language');  // Asegúrate de que el ID del campo del lenguaje es correcto
        var language = languageElement ? languageElement.value : null;

        if (!code) {
            console.error("Code is missing or undefined.");
            return;
        }
        if (!exerciseDescription) {
            console.error("Exercise description is missing or undefined.");
            return;
        }
        if (!language) {
            console.error("Language is missing or undefined.");
            return;
        }

        fetch('/users/run-code/', {
            method: 'POST',
            body: new URLSearchParams({
                'code': code,
                'language': language,
                'exercise_description': exerciseDescription
            }),
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            let feedback = data.feedback !== undefined ? data.feedback : "No feedback available.";
        
            let result = `Feedback: ${feedback}`; // Corrige la construcción de la cadena
            document.getElementById('exercise-result').innerText = result;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('exercise-result').innerText = `Error: ${error.message}`;
        });
    };
});
</script>
{% endblock %}