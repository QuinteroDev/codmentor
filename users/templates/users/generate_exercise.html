{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Generate a Programming Exercise</h2>
    <form method="POST" id="exercise-form">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary mt-3">Generate Exercise</button>
    </form>

    {% if exercise %}
    <h3>Exercise:</h3>
    <pre>{{ exercise }}</pre>

    <!-- Selector de lenguaje -->
    <select id="language" class="form-control mt-3">
        <option value="python">Python</option>
        <option value="javascript">JavaScript</option>
        <!-- Agrega más lenguajes aquí -->
    </select>

    <!-- Contenedor del editor -->
    <textarea id="code-editor" name="code-editor"></textarea>
    <button id="run-code-btn" class="btn btn-success mt-3">Run Code</button>
    <div id="exercise-result" class="mt-4"></div>
    {% endif %}
</div>

<!-- Inicialización de CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>

<!-- Estilos adicionales para mejorar la apariencia -->
<style>
    .CodeMirror {
        border: 1px solid #ddd;
        height: 300px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar CodeMirror
        var editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: "python",
            lineNumbers: true,
            theme: "default",
            tabSize: 4,
            indentWithTabs: true,
        });

        document.getElementById('run-code-btn').onclick = function(event) {
            event.preventDefault();
            var code = editor.getValue();
            var language = document.getElementById('language').value;
    
            fetch('/users/run-code/', {
                method: 'POST',
                body: new URLSearchParams({
                    'code': code,
                    'language': language
                }),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('exercise-result').innerText = "Error: " + data.error;
                } else {
                    document.getElementById('exercise-result').innerText = data.output;
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        };
    });
</script>
{% endblock %}